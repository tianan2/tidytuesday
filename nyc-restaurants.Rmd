---
title: "Untitled"
author: "Jaehwan Lim"
date: "December 19, 2018"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(tidyverse)
library(janitor)
library(lubridate)

set.seed(20181209)

# You can use this url to download the data directly into R (will take a few seconds)
restaurant_inspections_raw <- read_csv("https://data.cityofnewyork.us/api/views/43nn-pn8j/rows.csv")

# Cleaning names with janitor, sampling 300,000 records, and dropping some variables
restaurant_inspections <- restaurant_inspections_raw %>% 
        clean_names() %>%
        select(-phone, -grade_date, -record_date, -building, -street) %>% 
        sample_n(size = 300000) %>%
        mutate(inspection_date = mdy(inspection_date)) %>%
        separate(inspection_type, c("inspection_program", "inspection_type"), sep = " / ", )

```

```{r}
## see if each row is distinct in what terms
restaurant_inspections %>% 
  count(dba, camis, inspection_date, sort = T)

restaurant_inspections %>% 
  count(year = year(inspection_date)) 

restaurant_inspections %>% 
  count(violation_description, sort = T) %>% 
  head() %>% 
  pull(violation_description)
  
inspections <- restaurant_inspections %>% 
  group_by(camis, 
           dba,
           boro,
           zipcode,
           cuisine_description,
           inspection_date,
           action, 
           score, 
           grade, 
           inspection_type, 
           inspection_program) %>%
  summarize(critical_violations = sum(critical_flag == "Critical", na.rm = T), 
            noncritical_violations = sum(critical_flag == "Not Critical", na.rm = T)) %>% 
  ungroup()

most_recent_cycle_inspections <- inspections %>% 
  filter(inspection_program == "Cycle Inspection", 
         inspection_type == "Initial Inspection") %>% 
  arrange(desc(inspection_date)) %>% 
  distinct(camis, .keep_all = TRUE)

```

```{r}
library(broom)

by_cuisine <- most_recent_cycle_inspections %>% 
  group_by(cuisine_description) %>% 
  summarize(avg_score = mean(score), 
            median_score = median(score), 
            restaurant = n()) %>% 
  arrange(desc(restaurant))


cuisine_conf_ints <- most_recent_cycle_inspections %>% 
  add_count(cuisine_description) %>% 
  filter(n > 200) %>% 
  nest(-cuisine_description) %>% 
  mutate(model = map(data, ~ t.test(.$score))) %>% 
  unnest(map(model, tidy))

cuisine_conf_ints %>% 
  mutate(cuisine_description = str_remove(cuisine_description, " \\(.*"), 
         cuisine_description = fct_reorder(cuisine_description, estimate)) %>% 
  ggplot(aes(cuisine_description, estimate)) + 
  geom_point() + 
  geom_errorbar(aes(ymin = conf.low, ymax = conf.high, width = 0.2)) + 
  coord_flip()
  


```

